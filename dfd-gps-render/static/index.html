<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DFD GPS Correction — Live</title>

  <!-- DFD site chrome -->
  <link rel="icon" href="https://densityfielddynamics.com/favicon.png" type="image/png">
  <link rel="stylesheet" href="https://densityfielddynamics.com/style.css">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    .panel { background: var(--panel); border:1px solid var(--line); border-radius: var(--radius); box-shadow: var(--shadow); padding:16px }
    .grid { display:grid; grid-template-columns: 420px 1fr; gap:16px; align-items:start }
    .controls label{display:block; font-size:14px; color:var(--muted); margin-top:10px}
    .controls input{ width:100%; padding:10px 12px; font-size:16px; border-radius:12px; border:1px solid var(--line); background:#0e121a; color:var(--text)}
    #map{width:100%; height:560px; border-radius:12px; background:#0e121a}
    .kpi{display:flex; align-items:baseline; gap:12px; margin:6px 0 14px}
    .kpi .big{font-size:28px; font-weight:800; color:var(--accent)}
    .kpi .small{color:var(--muted)}
    pre{background:#0e121a; border:1px solid var(--line); border-radius:12px; padding:12px; overflow:auto}
    .pill{display:inline-block; padding:2px 8px; border:1px solid var(--line); border-radius:999px; color:var(--muted); font-size:12px; margin-left:8px}
    .section{padding-top:24px}
  </style>
</head>
<body>

<header class="site-header">
  <div class="container nav">
    <a class="brand" href="https://densityfielddynamics.com">
      <span><img src="https://densityfielddynamics.com/favicon.png" width="24" height="24" alt=""></span>
    </a>
    <nav class="menu">
      <a href="https://densityfielddynamics.com">Home</a>
      <a href="https://dfdgps.com">DFD GPS</a>
    </nav>
  </div>
</header>

<section class="section">
  <div class="container">
    <h1>DFD GPS Correction <span class="pill">live met + elevation</span></h1>
    <div class="grid">

      <div class="panel controls">
        <div class="kpi">
          <div class="big" id="kpiError">Naive error: –</div>
          <div class="small" id="kpiTiming"></div>
        </div>

        <label>Latitude <input id="lat" readonly></label>
        <label>Longitude <input id="lon" readonly></label>
        <label>Height h (m) <input id="h_m" readonly></label>
        <label>Elevation (deg) <input id="elev_deg" value="45"></label>
        <label>Azimuth (deg) <input id="az_deg" value="90"></label>
        <label>Range (m) <input id="range_m" value="20200000"></label>
        <label>Temperature (K) <input id="temp_K" readonly></label>
        <label>Pressure (Pa) <input id="pressure_Pa" readonly></label>
        <label>Relative Humidity (0–1) <input id="rh_frac" readonly></label>
        <div class="muted" id="liveHint">Loading…</div>
        <pre id="out">Waiting for GPS…</pre>
      </div>

      <div class="panel"><div id="map"></div></div>

    </div>
  </div>
</section>

<footer class="site-footer">
  <div class="container foot">
    <div class="muted">© Density Field Dynamics</div>
  </div>
</footer>

<script>
const DEG = Math.PI/180;
let map, dots={}, latestPos={}, lastMet={t:0}, computeTimer=null;

function initMap(lat, lon) {
  if (!map) {
    map = L.map('map').setView([lat, lon], 17);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19}).addTo(map);
    dots.true = L.circleMarker([lat, lon], {radius:8,color:'#21ba45',weight:3}).bindTooltip('True').addTo(map);
    dots.dfd = L.circleMarker([lat, lon], {radius:6,color:'#2185d0',fillColor:'#2185d0',fillOpacity:1}).bindTooltip('DFD').addTo(map);
    dots.naive = L.circleMarker([lat, lon], {radius:6,color:'#db2828',fillColor:'#db2828',fillOpacity:1}).bindTooltip('Naive').addTo(map);
    dots.line = L.polyline([[lat,lon],[lat,lon]], {color:'#db2828',dashArray:'5,5'}).addTo(map);
  }
}

async function getWeather(lat, lon) {
  const now = Date.now();
  if (now - lastMet.t < 60000) return; // throttle 1 min
  const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,surface_pressure`);
  const j = await res.json();
  const c = j.current;
  temp_K.value = (c.temperature_2m + 273.15).toFixed(2);
  rh_frac.value = (c.relative_humidity_2m / 100).toFixed(2);
  pressure_Pa.value = (c.surface_pressure * 100).toFixed(0);
  h_m.value = Math.round(j.elevation);
  liveHint.textContent = "Live data loaded (Open-Meteo)";
  lastMet.t = now;
}

function offset(lat, dx, dy) {
  const dLat = dy / 111320;
  const dLon = dx / (111320 * Math.cos(lat * DEG));
  return [lat + dLat, latestPos.lon + dLon];
}

async function computeDFD() {
  if (!latestPos.lat) return;
  await getWeather(latestPos.lat, latestPos.lon);
  const payload = {
    lat: latestPos.lat, lon: latestPos.lon, h_m: parseFloat(h_m.value),
    elev_deg: parseFloat(elev_deg.value), az_deg: parseFloat(az_deg.value),
    range_m: parseFloat(range_m.value), temp_K: parseFloat(temp_K.value),
    pressure_Pa: parseFloat(pressure_Pa.value), rh_frac: parseFloat(rh_frac.value)
  };
  try {
    const res = await fetch('/dfd-correct', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
    const data = await res.json();
    out.textContent = JSON.stringify(data,null,2);

    const elevRad = payload.elev_deg*DEG, azRad = payload.az_deg*DEG;
    const horiz = data.range_bias_m * Math.cos(elevRad);
    const dE = Math.sin(azRad)*horiz, dN = Math.cos(azRad)*horiz;
    const [nLat,nLon] = offset(payload.lat,dE,dN);

    dots.true.setLatLng([payload.lat,payload.lon]);
    dots.dfd.setLatLng([payload.lat,payload.lon]);
    dots.naive.setLatLng([nLat,nLon]);
    dots.line.setLatLngs([[payload.lat,payload.lon],[nLat,nLon]]);
    const dist = Math.hypot(dE,dN);
    kpiError.textContent = `Naive error: ${dist.toFixed(2)} m`;
    kpiTiming.textContent = `Timing bias: ${data.timing_bias_ns.toFixed(2)} ns`;
  } catch(e) {
    console.warn(e);
  }
}

navigator.geolocation.watchPosition(
  pos=>{
    latestPos = {lat:pos.coords.latitude, lon:pos.coords.longitude, h:pos.coords.altitude||0};
    lat.value = latestPos.lat.toFixed(6);
    lon.value = latestPos.lon.toFixed(6);
    h_m.value = Math.round(latestPos.h);
    if (!map) initMap(latestPos.lat, latestPos.lon);
  },
  err=>{ console.error(err); liveHint.textContent='GPS permission denied'; },
  { enableHighAccuracy:true }
);

setInterval(computeDFD, 500); // 2 Hz live updates
</script>
</body>
</html>
